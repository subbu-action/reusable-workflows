name: common-ci-cd 

on: 
  workflow_call: 
     inputs: 
       project: 
         required: true 
         type: string 
       component: 
         required: true 
         type: string 
       app_type: 
         required: true 
         type: string 
     secrets: 
        AWS_ACCESS_KEY_ID:
             required: true 
        AWS_SECRET_ACCESS_KEY: 
             required: true    
jobs: 
   ci: #job name 
    runs-on: self-hosted 
    outputs: 
       appVersion: ${{ steps.package-version.outputs.version }}
    steps: 
     - name: Checkout code 
       uses: actions/checkout@v3
     - name: check the files 
       run: ls -l 
     - name: Print the inputs 
       run: echo "project is ${{ inputs.project }}"  
     - name: Get app version 
       id: package-version 
       run: echo "VERSION=$(jq -r '.version' package.json)" >> "$GITHUB_OUTPUT"
     - name: print app version 
       run: echo ${{ steps.package-version.outputs.version }}                      
     - name: install dependencies 
       run: npm install 
     - name: docker build 
       run: docker build -t 888947293288.dkr.ecr.us-east-1.amazonaws.com/${{ inputs.project }}/${{ inputs.component }}:${{ steps.package-version.outputs.version }} .
     - name: Configure AWS Credentials
       uses: aws-actions/configure-aws-credentials@v5
       with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1 
     - name: push the image to ecr 
       run: |
         aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 888947293288.dkr.ecr.us-east-1.amazonaws.com
         docker push 888947293288.dkr.ecr.us-east-1.amazonaws.com/${{ inputs.project }}/${{ inputs.component }}   